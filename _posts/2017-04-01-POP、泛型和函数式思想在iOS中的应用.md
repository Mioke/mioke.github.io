---
layout: post
---

# POPã€æ³›å‹å’Œå‡½æ•°å¼æ€æƒ³åœ¨iOSä¸­çš„åº”ç”¨

## ä¸»è¦å†…å®¹
- ä»€ä¹ˆæ˜¯POPï¼Ÿ
- POPåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨å®è·µ
- å‡½æ•°å¼ç¼–ç¨‹å’ŒSwiftä¸­æ³›å‹ç¼–ç¨‹
- Swiftä¸­POPä¸æ³›å‹ã€å‡½æ•°å¼ç¼–ç¨‹çš„ç»“åˆã€‚

### ä»€ä¹ˆæ˜¯POP  (Protocol-oriented-programing)

- åœ¨æˆ‘ä»¬å¹³å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸ä½¿ç”¨çš„æ˜¯OOPï¼ˆObject-Oriented-Programingï¼‰ï¼Œæ¯”å¦‚C++ã€OCã€JAVAã€‚ä»–ä»¬æ˜¯æŠŠä¸€äº›æ•°æ®æˆ–åŠ¨ä½œé›†åˆå½“åšä¸€ä¸ªå¯¹è±¡æ¥çœ‹å¾…ï¼Œæ¯”å¦‚æ ‘ã€äººã€æœºå™¨ç­‰ã€‚POPåˆ™ä¸åŒï¼Œå®ƒä»å¦ä¸€ä¸ªè§†è§’çœ‹å¾…äº‹ç‰©ï¼šå±æ€§ã€‚ä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰çš„æ•°æ®å±æ€§å’ŒåŠ¨ä½œå±æ€§ï¼Œéƒ½å¯ä»¥æˆä¸ºä¸€ç§åè®®ï¼ˆprotocolï¼‰ï¼Œä¸åŒçš„å¯¹è±¡é—´æœ‰ç€å…±åŒçš„åè®®æˆ–ç›¸ä¼¼çš„åè®®ã€‚
- å®é™…ç¼–ç è¿‡ç¨‹ä¸­ï¼Œå®šä¹‰å„ç§åè®®æ¥è§„èŒƒå’Œæ‹“å±•ç±»çš„æ–¹å¼ï¼Œç»Ÿç§°å«åšPOPã€‚

### ä¸¾ä¸ªğŸŒ°

ä»¥å‰æˆ‘ä»¬å¯èƒ½ä¼šè¿™æ ·æ„å»ºä¸€ä¸ªç±»ï¼š 
```swift
class bird {
    var name = ""
    var canFly = true
}

class penguin: bird {
    override init() {
        super.init()
        self.canFly = false
        self.name = "penguin"
    }
}
```
å¯¹äºOOPæ¥è¯´æ˜¯è¿™æ ·å®šä¹‰çš„ï¼Œbirdä¸ºpenguinçš„çˆ¶ç±»ï¼Œå­ç±»ç»§æ‰¿å’Œè¦†ç›–äº†çˆ¶ç±»çš„å±æ€§ã€‚
è€Œåœ¨POPä¸­ï¼Œæˆ‘ä»¬è¿™ä¹ˆå¹²:
```
protocol Flyable {
    var canFly: Bool { get }
}

struct Plane: Flyable {
    var canFly: Bool = true
}

struct Swallow: Flyable {
    var canFly: Bool = true
}
```
æ˜æ˜¾Flyableå±æ€§å…¶å®ä¸å•ç‹¬å±äºé¸Ÿç±»ï¼Œå®ƒåŒæ ·ä¹Ÿæ˜¯å¾ˆå¤šå…¶ä»–å¯¹è±¡çš„å±æ€§ã€‚æ‰€ä»¥åœ¨æ„é€ å…¶ä»–å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»–ä»¬è´´ä¸ŠåŒæ ·çš„â€œæ ‡ç­¾â€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯•ç€ä¸°å¯Œä¸€ä¸‹æˆ‘ä»¬çš„æ ‡ç­¾ã€‚
æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¯ä»¥æè¿°é€Ÿåº¦çš„åè®®ï¼š
```swift
protocol Racer {
    var speed: Double { get }
}

extension Plane: Racer {
    var speed: Double {
        return 1000
    }
}

extension Swallow: Racer {
    var speed: Double {
        return 200
    }
}
```
è¿™æ ·ï¼Œæˆ‘ä»¬çš„âœˆï¸å’ŒğŸ¦å°±æ‹¥æœ‰é€Ÿåº¦äº†~ ç„¶åæˆ‘ä»¬å¯ä»¥ç”¨Raceræ¥è¿›è¡Œæ‹“å±•ã€‚
æ‹“å±•ä¸€ä¸ªå¾ˆç®€å•çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬çŸ¥é“Arrayæ˜¯ç»§æ‰¿Sequenceåè®®çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Sequenceä¸­åŠ å…¥ä¸€ä¸ªåŠŸèƒ½ï¼Œä½¿å¾—å¿«é€Ÿæ‰¾å‡ºSequenceä¸­é€Ÿåº¦æœ€å¿«çš„å¯¹è±¡ã€‚
```swift
extension Sequence where Iterator.Element == Racer {
    func fastest() -> Iterator.Element? {
        return self.max(by: { (a: Iterator.Element, b: Iterator.Element) -> Bool in
            return a.speed < b.speed
        })
    }
}

let plane = Plane()
let swallow = Swallow()

let array: Array<Racer> = [plane, swallow]
array.fastest()
```
è¿™æ ·Arrayå°±å…·æœ‰äº†ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ç§æ€æƒ³å»æ„å»ºä¸€ä¸ªä½“ç³»ï¼ŒSwiftä¸­çš„Arrayå’ŒDictionaryå°±æ˜¯å¾ˆå¥½çš„ä¾‹å­ã€‚

### Popçš„ç®€å•åº”ç”¨
å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒiOSçš„TableViewæˆ‘ä»¬é€šå¸¸è¿™æ ·å†™ï¼š
```swift
class CommentCell: UITableViewCell {}

class MyViewcontroller: UIViewController, UITableViewDelegate, UITableViewDataSource {
    
    var tableView = UITableView()
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        let cellNib = UINib(nibName: "CommentCell", bundle: nil)
        tableView .register(cellNib, forCellReuseIdentifier: "comment_cell")
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        guard let cell = tableView.dequeueReusableCell(withIdentifier: "comment_cell", for: indexPath) as? CommentCell else {
            return UITableViewCell()
        }
        return cell;
    }
}
```
è¿™çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œå¤¹æ‚ç€å„ç§åˆ¤æ–­å’Œè½¬æ¢ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Swiftçš„ç‰¹æ€§å’ŒPOPæ–¹å¼ï¼š
```swift
protocol ReusableView {
}

extension ReusableView where Self: UITableViewCell {
    static var reusedIdentifier: String {
        return String(describing: self.self)
    }
}


protocol NibLoadableView: class { }

extension NibLoadableView where Self: UIView {
    
    static var NibName: String {
        return String(describing: self.self)
    }
}

extension CommentCell: ReusableView, NibLoadableView {
}
```
æœ‰äº†è¿™ä¸¤ä¸ªåè®®ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹TableViewçš„æ–¹æ³•è¿›è¡Œæ”¹é€ ï¼Œä½¿ç”¨**æ³›å‹**æ–¹æ³•ï¼š
```swift
extension UITableView {
    func registerNib<T: UITableViewCell>(_: T.Type) -> Void 
        where T: ReusableView, T: NibLoadableView {

        let nib = UINib(nibName: T.NibName, bundle: nil)
        self.register(nib, forCellReuseIdentifier: T.reusedIdentifier)
    }
    func dequeReusableCell<T: UITableViewCell>(forIndexPath ip: IndexPath) -> T 
        where T: ReusableView {

        guard let cell = self.dequeueReusableCell(withIdentifier: T.reusedIdentifier, for: ip) as? T else {
            fatalError("couldn't deque cell with identifier: \(T.reusedIdentifier)")
        }
        return cell
    }
}
```
ç„¶ååœ¨å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸€åˆ‡å˜å¾—æ›´å¥½äº†
```swift
extension MyViewcontroller {
    
    func register() -> Void {
        tableView.registerNib(CommentCell.self)
    }

    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) ->             
        UITableViewCell {
        return tableView.dequeReusableCell(forIndexPath: indexPath) as CommentCell
    }
}
```
è¿™åªæ˜¯ä¸ªå®ä¾‹ï¼Œè¿™ç§æ€æƒ³å¹¶ä¸ä¼šä¸€å®šå¸®åŠ©ä½ çš„ä»£ç æ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯åˆç†åˆ©ç”¨ä¸‹ï¼Œä¼šè®©ä½ çš„ä»£ç å¯è¯»æ€§å˜å¾—å¾ˆå¼ºï¼Œæ‹“å±•æ€§å˜çš„æé«˜ï¼Œæ€è·¯å˜å¾—æ¸…æ™°ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹åœ¨å®é™…é¡¹ç›®ä¸­POPçš„åº”ç”¨ã€‚

### ä¸€ä¸ªç½‘ç»œå±‚æ¡†æ¶
è¿™ä¸ªæ˜¯ä¸€ä¸ªé¡¹ç›®ä¸­å®é™…ä½¿ç”¨çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶ã€‚åœ¨çˆ¶ç±»çš„`APIManager`ä¸­åŒ…å«äº†ä¸€ä¸ªæŒ‡å‘å­ç±»çš„æŒ‡é’ˆï¼Œå¹¶ä¸”å¼ºåˆ¶å­ç±»å®ç°ä¸€ä¸ª`APIManagerProtocol`ã€‚

![image](https://raw.githubusercontent.com/Mioke/resources/master/images/tmp283a3cb5.png)

çˆ¶ç±»åˆå§‹åŒ–æ—¶è¦æ±‚å­ç±»çš„çº¦æŸæ¡ä»¶ã€‚
```objc
- (instancetype)init {
    
    if (self = [super init]) {
        
        if ([self conformsToProtocol:@protocol(XLAPIManagerProtocol)]) {
            self.child = (id <XLAPIManagerProtocol>)self;
            self.shouldAutoRetry = [self.child respondsToSelector:@selector(autoRetryCountWithErrorCode:)];
            self.autoProcessReceivedData = YES;
        } else {
            NSAssert(NO, @"APIManager å­ç±»å¿…é¡»é›†æˆXLAPIManagerProtocl");
        }
    }
    return self;
}
```
åˆ©ç”¨self.childæ¥è§„èŒƒå­ç±»çš„å®ç°ï¼ŒåŒæ—¶é€šè¿‡protocolæ¥è·å–å­ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œä½¿åŠŸèƒ½å®ç°èšåˆåœ¨BaseAPIä¸­ã€‚æ¯”å¦‚è¿™ä¸ªè·å–å®Œæ•´URLStringçš„æ–¹æ³•ï¼š
```objc
- (NSString *)fullURLString {
    if (!self.urlString) {
        NSMutableString *url = [NSMutableString stringWithString:[self.child server].url];
        
        if ([self.child apiVersion] && [self.child apiVersion].length > 0) {
            [url appendFormat:@"/%@", [self.child apiVersion]];
        }
        [url appendFormat:@"/%@", [self.child apiName]];
        
        self.urlString = url;
    }
    return self.urlString;
}
```
å®ç°åæˆ‘ä»¬ä¼šå‘ç°ï¼Œå­ç±»å®ç°APIä¼šéå¸¸æ¸…æ™°å’Œç®€æ´ã€‚ä¸€ä¸ªAPIç±»çš„å®ç°ï¼Œåªéœ€è¦å‡ è¡Œä»£ç 
```objc
@implementation KNBindInfoAPIManager
- (NSString *)apiName {
    return @"bindinfo";
}
- (NSString *)apiVersion {
    return @"";
}
- (NSString *)httpMethod {
    return @"GET";
}
- (XLServer *)server {
    return [XLVipExtServer sharedServer];
}
@end
```

åœ¨ä»¥å‰çš„é”™è¯¯ç å¤„ç†ä¸­ï¼Œéƒ½æ˜¯ç»Ÿä¸€åœ¨`APIManagerä¸­`å¤„ç†ã€‚ä½†æ˜¯åæ¥é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºè¯·æ±‚çš„æœåŠ¡å™¨ä¸åŒï¼Œå¯¼è‡´é”™è¯¯ç å¤„ç†ä¸ä¸€è‡´ï¼Œå†çœ‹æˆ‘ä»¬ä¹‹å‰çš„å®ç°ï¼Œå°±æœ‰ç‚¹ä»£ç çš„åå‘³é“äº†ã€‚åˆ†æåå‘ç°ï¼Œé”™è¯¯ç å…¶å®æ˜¯å’ŒæœåŠ¡å™¨æŒ‚é’©ï¼ŒçœŸæ­£è¯¥å¦‚ä½•å¤„ç†ä¸€ä¸ªæ•°æ®åº”è¯¥æ˜¯ç”±è¯¥æœåŠ¡å™¨è¯´äº†ç®—ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™`XLServer`è¿™ä¸ªç±»åŠ äº†ä¸€ä¸ªåè®®ï¼š
```objc
@protocol XLServerDataProcessProtocol <NSObject>
/**
 *  å¤„ç†æ•°æ®ï¼Œå¯æŠ›å‡ºå¼‚å¸¸æˆ–è¯·æ±‚é‡è¯•ã€‚
 *
 *  @param data  è¦å¤„ç†çš„æ•°æ®
 *  @param error é”™è¯¯
 *  @param retry æ˜¯å¦éœ€è¦é‡è¯•
 */
- (void)handleData:(id)data error:(NSError **)error shouldRetry:(BOOL *)retry;

// åœ¨çˆ¶APIManager.m å®ç°ä¸­
if ([self.child.server conformsToProtocol:@protocol(XLServerDataProcessProtocol)]) {
            
    NSError *error = nil;
    BOOL retry = NO;
    [(id <XLServerDataProcessProtocol>)self.child.server handleData:responseObject
                                                              error:&error
                                                        shouldRetry:&retry]
}
```
åœ¨APIå¤„ç†ç»“æœä¸­ï¼Œå¯¹å½“å‰å­ç±»çš„serverè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæœ‰å“åº”åè®®ï¼Œåˆ™äº¤ç»™ç›¸åº”æœåŠ¡å™¨å¯¹è±¡å¤„ç†ã€‚
è¿™äº›åœ¨Objective-Cä¸­çš„å®è·µä¾‹å­ï¼Œå®é™…ç”¨å¤„æ˜¯è§„èŒƒäº†å„ä¸ªç±»çš„æ•°æ®å’ŒåŠ¨ä½œçš„å®ç°ï¼Œä½¿å¾—ä»£ç ç»“æ„å˜å¾—æ¸…æ™°ï¼Œé€»è¾‘ä¸¥å¯†ã€‚

### ç®€è°ˆå‡½æ•°å¼ç¼–ç¨‹
- åœ¨Swiftä¸­ï¼Œå‡½æ•°æˆä¸ºäº†First class valueï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä¼ é€’ã€ä½¿ç”¨å‡½æ•°å°±åƒä½¿ç”¨ä¸€ä¸ªæ•°å­—ã€ä¸€ä¸ªå­—ç¬¦ä¸²ä¸€æ ·ç®€å•ã€‚
- å¯ä»¥ç²—ç•¥çš„çœ‹å¾…ä¸€ä¸ªå‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ªè¿‡ç¨‹ã€‚
- æˆ‘ä»¬å¯ä»¥é€šè¿‡å˜æ¢å‡½æ•°ï¼Œåˆ›é€ ä¸€ä¸ªä¸ªâ€œå°å·¥å…·â€ï¼Œè¿™äº›å·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºå¤æ‚çš„è¿‡ç¨‹ã€‚
- å‡½æ•°æ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•å’Œæ‰¾å‡ºbug

#### ä¸€ä¸ªç®€å•çš„å‡½æ•°å¼æ€æƒ³çš„ä¾‹å­
å‡å¦‚æˆ‘ä»¬å†™ä¸€ä¸ªæˆ˜èˆ¹çš„ä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥å®šä½æ•Œæ–¹æˆ˜èˆ¹æ˜¯å¦åœ¨æˆ‘ä»¬çš„æœ‰æ•ˆå°„ç¨‹èŒƒå›´å†…ï¼š
```swift
typealias Distance = Double

struct Position {
    var x: Double
    var y: Double
}

extension Position {
    func inRange(range: Distance) -> Bool {
        return sqrt(x * x + y * y) <= range
    }
}

struct Ship {
    var position: Position
    var firingRange : Distance
    var unsafeRange : Distance
}
extension Ship {
    // æœ€åˆæˆ‘ä»¬å°±åˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨å°„ç¨‹èŒƒå›´é‡Œ
    func canEngageShip(target: Ship) -> Bool {
        let dx = target.position.x - position.x
        let dy = target.position.y - position.y
        
        return sqrt(dx * dx + dy * dy) <= firingRange
    }
    // å‘ç°åŒæ—¶ï¼Œæ•Œæ–¹ä¹Ÿä¸èƒ½ç¦»æˆ‘ä»¬å¤ªè¿‘
    func canSafelyEngageShip(target: Ship) -> Bool {
        let dx = target.position.x - position.x
        let dy = target.position.y - position.y
        let targetDistance = sqrt(dx * dx + dy * dy)
        return targetDistance <= firingRange && targetDistance > unsafeRange
    }
    // å‹æ–¹æˆ˜èˆ¹ä¹Ÿä¸èƒ½ç¦»ç›®æ ‡å¤ªè¿‘
    func canSafelyEngageShip1(target: Ship, friendly: Ship) -> Bool {
        let dx = target.position.x - position.x
        let dy = target.position.y - position.y
        let targetDistance = sqrt(dx * dx + dy * dy)
        let friendlyDx = friendly.position.x - target.position.x
        let friendlyDy = friendly.position.y - target.position.y
        
        let friendlyDistance = sqrt(friendlyDx * friendlyDx +
            friendlyDy * friendlyDy)
        return targetDistance <= firingRange
            && targetDistance > unsafeRange && (friendlyDistance > friendly.unsafeRange)
    }
}
```

ä¸ºäº†ç®€åŒ–è®¡ç®—ï¼Œæˆ‘ä»¬æŠ½å–å…¶ä¸­çš„å‡ ä¸ªæ–¹æ³•ï¼š
```swift
extension Position {
    func minus(_ p: Position) -> Position {
        return Position(x: x - p.x, y: y - p.y)
    }
    var length: Double {
        return sqrt(x * x + y * y)
    }
}

extension Ship {
    func canSafelyEngageShip2(target: Ship, friendly: Ship) -> Bool {
        let targetDistance = target.position.minus(self.position).length
        let friendlyDistance = friendly.position.minus(target.position).length
        
        return targetDistance <= firingRange
            && targetDistance > unsafeRange && (friendlyDistance > unsafeRange)
    }
}
```
æœ€ç»ˆè¿™ä¸ªå‡½æ•°è¡¨ç°æˆè¿™æ ·ï¼Œçœ‹èµ·æ¥æ¡ä¾‹æ¸…æ™°ï¼Œé€»è¾‘æ¸…æ¥šï¼Œä½†æ˜¯éš¾å…åœ¨æ•´ä¸ªå‡½æ•°æ„å»ºè¿‡ç¨‹ä¸­å‘ç°ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«ç€ä¸€æ¬¡æ¬¡é‡æ„ã€‚

ç°åœ¨æˆ‘ä»¬æ¢ä¸ªæ€è·¯ï¼ŒæŠŠè¿™ä¸€ä¸ªå…³é”®çš„åˆ¤æ–­è¿‡ç¨‹çœ‹åšä¸€ä¸ªå¯¹è±¡:
```swift
typealias Region = (Position) -> Bool
```
æˆ‘ä»¬æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰æˆä¸€ä¸ªåä¸ºåŒºåŸŸçš„ç±»å‹ã€‚ç„¶åæˆ‘ä»¬éœ€è¦ä¸€äº›å·¥å…·æ¥ç”Ÿæˆæˆ–è€…æ”¹å˜åŒºåŸŸï¼š

```swift
func circle(_ radius: Distance) -> Region {
    return { $0.length <= radius }
}
func shift(_ region: @escaping Region, offset: Position) -> Region {
    return { region($0.minus(offset)) }
}
func invert(_ region: @escaping Region) -> Region {
    return { !region($0) }
}
func intersection(_ region1: @escaping Region, _ region2: @escaping Region) -> Region {
    return { point in
        region1(point) && region2(point)
    }
}
func union(_ region1: @escaping Region, _ region2: @escaping Region) -> Region {
    return { point in region1(point) || region2(point) }
}
func difference(_ region1: @escaping Region, minus: @escaping Region) -> Region {
    return intersection(region1, invert(minus))
}
```
æœ‰äº†è¿™äº›å°å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„å®šä¹‰ä¹‹å‰çš„å‡½æ•°
```swift
extension Ship {
    func canSafelyEngageShip(target: Ship, friendly: Ship) -> Bool {
        // ç”Ÿæˆè‡ªå·±çš„å®‰å…¨æ”»å‡»èŒƒå›´
        let rangeRegion = difference(circle(firingRange), minus: circle(unsafeRange))
        // ä½ç§»ä¸€ä¸‹åˆ°æˆ˜èˆ¹æ‰€å¤„åæ ‡
        let firingRegion = shift(rangeRegion, offset: position)
        // ç”Ÿæˆå‹æ–¹çš„å®‰å…¨èŒƒå›´
        let friendlyRegion = shift(circle(friendly.unsafeRange),offset: friendly.position)
        // ç”Ÿæˆå®é™…æœ‰æ•ˆèŒƒå›´
        let resultRegion = difference(firingRegion, minus: friendlyRegion)
        return resultRegion(target.position)
    }
}

let me = Ship(position: Position(x: 0, y: 0), firingRange: 100, unsafeRange: 20)
let target = Ship(position: Position(x: 77, y: -10), firingRange: 100, unsafeRange: 20)
let friendly = Ship(position: Position(x: 59, y: 8), firingRange: 100, unsafeRange: 20)

me.canSafelyEngageShip(target: target, friendly: friendly)
// output: true
```
### POPã€æ³›å‹å’Œå‡½æ•°å¼ç¼–ç¨‹çš„ç»“åˆ
æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ“ä½œè¿‡ç¨‹ï¼Œä¼ å…¥ä¸€ä¸ªå‚æ•°äº§ç”Ÿä¸€ä¸ªç»“æœã€‚è¿™ç§åŸºç¡€è¿‡ç¨‹éå¸ƒæˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼š
```swift
enum Result<T> {
    case success(T)
    case failed(Error)
}

typealias fu_operation<E, T> = (E) -> Result<T>
```
è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæšä¸¾çš„ç»“æœç±»å‹ï¼Œç”¨æ³›å‹è¡¨ç¤ºç»“æœä¸­çš„å®é™…ç±»å‹ã€‚å®šä¹‰çš„operationè¡¨ç¤ºè¾“å…¥ä¸€ä¸ªEç±»å‹çš„æ•°æ®ï¼Œäº§ç”Ÿä¸€ä¸ª`Result<T>`ç±»å‹çš„ç»“æœã€‚

ç„¶åæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªcombineå‡½æ•°ï¼Œç”¨äºç»“åˆä¸¤ä¸ªoperationï¼š
```swift
func combine<E, T, H>(op1: @escaping fu_operation<E, T>, op2: @escaping fu_operation<T, H>) -> fu_operation<E, H> {
    return { params in
        let rst = op1(params)
        
        switch rst {
        case .success(let value):
            return op2(value)
        case .failed(let e):
            return .failed(e)
        }
    }
}
```

æµ‹è¯•ä¸€ä¸‹ï¼Œaæ˜¯å°†å­—å…¸æ‰€æœ‰keyå€¼å–å‡ºæ¥ç¼–ç¨‹æ•°ç»„çš„è¿‡ç¨‹ï¼Œbæ˜¯æŠŠæ•°ç»„è½¬æˆå¯è¯»å­—ç¬¦ä¸²çš„è¿‡ç¨‹ï¼š
```swift
let a: fu_operation<[String: Any] ,[String]> = { params in
    return .success(
        params.reduce([String](), { (rst: [String], couple: (key: String, value: Any)) -> [String] in
            var newRst: [String] = rst
            newRst.append(couple.key)
            
            return newRst
        })
    )
}
let b: fu_operation<[String], String> = {params in
    var str = ""
    for value in params {
        str.append(value + " ,")
    }
    return .success(str)
}

combine(op1: a, op2: b)(["a": 1, "b": 2])

//è¾“å‡ºä¸ºï¼š
//success("b ,a ,")

```

ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªç±»ï¼Œä»¥åä¹Ÿå¯ä»¥åœ¨å…¶ä¸­åšæ‰©å±•ï¼š
```swift
class st_operation<E, T> {
    var op: fu_operation<E, T> = { _ in .failed(NSError())}
    init() {
    }
    init(with operation: @escaping (E) -> Result<T>) {
        self.op = operation
    }
}
```

ä»¥ä¸€ä¸ªæ•°æ®è¯·æ±‚åŠ¨ä½œä¸ºä¾‹ï¼Œæ‹¿åˆ°çš„æ•°æ®é€šå¸¸æ˜¯JSONè½¬æ¢æˆçš„Dictionaryï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåè®®ï¼š
```
protocol ConstructableFromDictionary {
    static func generate(from dictionary: [String: Any]) -> Self?
}
```
æ¥ç€æˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„APIåŠ¨ä½œï¼ŒåŠ¨ä½œæœ‰ä¸¤ä¸ªæ“ä½œï¼Œä¸€ä¸ªæ˜¯å‘èµ·è¯·æ±‚è·å–æºæ•°æ®ï¼Œä¸€ä¸ªæ˜¯è½¬æ¢å…ƒæ•°æ®åˆ°æˆ‘ä»¬å®šä¹‰çš„æ¨¡å‹ï¼š
```swift
typealias Parameters = [String: Any]
class API<T: ConstructableFromDictionary> {
    var requestOperation: st_operation<Parameters, [String: Any]>
        = st_operation { .success(Request.GET(params: $0)) }
    
    var transform: st_operation<[String: Any], T> = st_operation {
        if let rst = T.generate(from: $0) { return .success(rst) }
        else { return .failed(NSError()) }
    }
    
    func request(params: Parameters?) throws -> T {
        // é¦–å…ˆç»“åˆä¸¤ä¸ªæ“ä½œï¼Œç„¶åè¿”å›å…¶ä¸­çš„ç»“æœ
        let op = combine(op1: self.requestOperation.op, op2: self.transform.op)
        let result = op(params ?? [:])
        
        switch result {
        case .success(let value):
            return value
        case .failed(let error):
            throw error
        }
    }
}
```
å‡å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦æ‹‰å–ä¸€ä¸ªæ°´æœçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ªæ°´æœçš„ç±»ï¼Œä½¿ä»–å®ç°åè®®ï¼š
```swift
class Fruit: ConstructableFromDictionary {
    var name: String = ""
    required init() {
    }
    static func generate(from dictionary: [String : Any]) -> Self? {
        let fruit = self.init()
        fruit.name = dictionary["name"] as? String ?? ""
        return fruit
    }
}
```
è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ä¸ç”¨å†™å…¶ä»–ä»»ä½•å¤šä½™ä»£ç ï¼Œå°±å¯ä»¥åˆ©ç”¨åŸºç¡€çš„APIç±»åšåˆ°æ•°æ®è¯·æ±‚ã€‚
```swift
let fruitAPI = API<Fruit>()
do {
    let fruit = try fruitAPI.request(params: nil)
    fruit.name // Get fruit's name success, yeah
} catch {
    // deal error
}
```
## æ€»ç»“

- Swiftå¸¦ç»™æˆ‘ä»¬çš„æ–°ä½“éªŒæ˜¯Amazingçš„ï¼Œè™½ç„¶POPæˆ–IOPæ¦‚å¿µå¾ˆæ—©å°±æœ‰ï¼Œä½†æ˜¯ç»“åˆæ³›å‹å’Œå‡½æ•°å¼ç¼–ç¨‹ï¼Œå­¦ä¹ å®ƒè€Œå¸¦ç»™æˆ‘ä»¬çš„æ˜¯æ€ç»´ä¸Šçš„è¿›åŒ–æˆ–è€…é©å‘½ï¼Œè®©æˆ‘ä»¬æ‹¥æœ‰æ›´æ–°çš„è§†è§’ã€‚
- å¯¹äºiOSè€Œè¨€ï¼Œå®é™…åº”ç”¨ä¸­ï¼ŒOOPå’ŒPOPæ··åˆä½¿ç”¨æ˜¯å¿…ä¸å¯å°‘çš„ï¼ŒPOPçš„åŠ å…¥çš„æ„ä¹‰æ˜¯ä½¿ä»£ç æ›´è§„èŒƒã€çµæ´»ï¼Œä½¿ç»“æ„å’Œé€»è¾‘æ›´æ¸…æ™°æ˜“æ‡‚ã€‚
- ä»¥ä¸Šæ‰€æœ‰ä»£ç éƒ½æ˜¯Swift-Onlyçš„ï¼Œæ‰€ä»¥åœ¨ä»¥åè·¨å¹³å°ä¸Šï¼ŒSwiftå’ŒPOPä¼šæ›´æœ‰ä¼˜åŠ¿ã€‚å½“ç„¶åœ¨iOSä¸ŠOCè¿˜æ˜¯èˆå¼ƒä¸æ‰çš„ï¼ŒOCçš„ä¼˜åŠ¿æ˜¯æ›´çµæ´»çš„Runtimeï¼Œå®é™…åº”ç”¨ä¸­æ›´éœ€å„å–æ‰€é•¿ã€‚å†™Swiftä»£ç ä¹Ÿå°½é‡é¿å…rewrite OC codeã€‚

### å‚è€ƒ
- [B]Functional Swift - Chris Eidhof, Florian Kugler, Wouter Swierstra

### æ‰©å±•é˜…è¯»
- [Functors, Applicatives, And Monads In Pictures](http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html)
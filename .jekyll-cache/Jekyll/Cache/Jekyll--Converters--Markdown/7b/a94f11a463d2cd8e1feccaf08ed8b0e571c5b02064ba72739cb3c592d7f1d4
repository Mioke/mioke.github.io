I"ÚA<h2 id="weex-ä¸-ios-native-çš„ä¼ è¾“">Weex ä¸ iOS Native çš„ä¼ è¾“</h2>

<p>åœ¨ä½¿ç”¨Weexæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æ•°æ®å’Œäº‹ä»¶ä¸nativeä¹‹é—´çš„äº¤äº’ï¼Œå¤šå‘ç”Ÿäºç•Œé¢äº‹ä»¶å’Œæ•°æ®ä¼ è¾“ã€‚ä¸¾ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼ŒWeex pageä¸­ä¸€é¡¹å†…è´­çš„é¡µé¢ï¼Œéœ€è¦æ˜¾ç¤ºApple storeçš„ä»·æ ¼ï¼Œæ­¤æ—¶éœ€è¦nativeä»æœåŠ¡å™¨æ‹¿åˆ°ä»·æ ¼åå‘é€ç»™weex pageåšæ˜¾ç¤ºã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬weexå‘é€è¯·æ±‚åˆ°æœ¬åœ°ï¼Œæœ¬åœ°å¤„ç†å›è°ƒç­‰ã€‚</p>

<p>æœ¬æ–‡ä¸»è¦å†…å®¹å°±æ˜¯ï¼Œå¦‚ä½•å®ç°è¿™ä¸€è¿‡ç¨‹åŠä¿è¯ç»Ÿä¸€ã€ä½è€¦åˆçš„ä¸­é—´å±‚ã€‚</p>

<h3 id="å®ç°åŸç†">å®ç°åŸç†</h3>

<h4 id="weex-ç«¯å‘é€è¯·æ±‚">Weex ç«¯å‘é€è¯·æ±‚</h4>
<p>åœ¨Weexç•Œé¢çš„JS scriptä¸­ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡è°ƒç”¨Appæ³¨å†Œçš„æ¨¡ç»„æ¥ç›´æ¥è°ƒç”¨æ–¹æ³•ã€‚åœ¨demoä¸­ï¼Œå¤„ç†è¿™ä¸€è¿‡ç¨‹çš„æ˜¯<code class="language-plaintext highlighter-rouge">XLPluginEvent</code>ç±»ã€‚åœ¨åˆå§‹åŒ–SDKæ—¶ï¼Œé€šè¿‡æ³¨å†Œï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">WXSDKEngine</span> <span class="nf">registerModule</span><span class="p">:</span><span class="s">@"mediator"</span> <span class="nf">withClass</span><span class="p">:</span><span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@"XLPluginEvent"</span><span class="p">)];</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>JSç«¯å°±å¯ä»¥é€šè¿‡æ³¨å†Œçš„ç±»å…¶ä¸­çš„æ–¹æ³•ï¼Œæ¥å‘èµ·ä¸€ä¸ªEventï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">weex</span><span class="p">.</span><span class="nx">requireModule</span><span class="p">(</span><span class="dl">'</span><span class="s1">mediator</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">sendRequestData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="dl">'</span><span class="s1">pluginA</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">native</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ret</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">ret</span>
	<span class="nx">modal</span><span class="p">.</span><span class="nx">toast</span><span class="p">({</span>
		<span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">receive</span><span class="dl">'</span><span class="p">,</span>
		<span class="na">duration</span><span class="p">:</span> <span class="mf">0.3</span>
	<span class="p">})</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>JSç«¯çš„functionå¯ä»¥ä»¥å‚æ•°ä¼ é€’ç»™nativeå¹¶ä»¥blockå½¢å¼è°ƒç”¨ã€‚è¿™æ ·å°±å®ç°äº†JSç«¯å‘èµ·Eventå¹¶å¯ä»¥è·å¾—å›è°ƒã€‚</p>

<h4 id="nativeå‘èµ·events">Nativeå‘èµ·Events</h4>

<p>Nativeç«¯å¯æœ‰ä¸¤ç§æ–¹å¼ä¼ é€’eventsè‡³Weexã€‚</p>

<ul>
  <li>é€šè¿‡WXSDKManageræä¾›çš„fireEvent:ref:type:params:domChanges:æ–¹æ³•ã€‚ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨weex pageä¸Šç›‘å¬åˆ°äº‹ä»¶ï¼Œå¦‚
    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">[[</span><span class="n">WXSDKManager</span> <span class="nf">bridgeMgr</span><span class="p">]</span> <span class="nf">fireEvent</span><span class="p">:</span><span class="n">targetWX</span><span class="p">.</span><span class="n">InstanceId</span>
                             <span class="nl">ref:</span><span class="s">@"_root"</span> 
                            <span class="nl">type:</span><span class="s">@"nativetransport"</span>
                          <span class="nl">params:</span><span class="n">paramsAddCallback</span>
                      <span class="nl">domChanges:</span><span class="nb">nil</span><span class="p">];</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-html" data-lang="html">  <span class="nt">&lt;template&gt;</span>
    <span class="nt">&lt;text</span> <span class="na">onClick=</span><span class="s">'onClick'</span> <span class="na">onnativetransport=</span><span class="s">""</span> <span class="na">id=</span><span class="s">'text1'</span><span class="nt">&gt;</span>callback: <span class="nt">&lt;/text&gt;</span>
  <span class="nt">&lt;/template&gt;</span>

  <span class="nt">&lt;script&gt;</span>
    <span class="err">#</span> <span class="nx">ä¸Šç•¥</span>
    <span class="nx">nativeTransport</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="nt">&lt;/script&gt;</span></code></pre></figure>

<ul>
  <li>é€šè¿‡fireGlobalEvent:params:æ–¹æ³•
è¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯å‘é€ä¸€ä¸ªå…¨å±€é€šçŸ¥ï¼Œæ‰€æœ‰å·²å­˜åœ¨çš„Weex pageéƒ½èƒ½æ¥æ”¶åˆ°è¿™ä¸ªEventï¼Œä½†å‰ææ˜¯Weex pageåˆå§‹åŒ–æ—¶æ³¨å†Œlistenerã€‚
    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">globalEvent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@weex-module/globalEvent</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">globalEvent</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">nativetransport</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
 <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">native send a request</span><span class="dl">"</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>è¿™æ—¶nativeè°ƒç”¨<code class="language-plaintext highlighter-rouge">fireEvent</code>å°±å¯ä»¥è§¦å‘è¿™ä¸ªç›‘å¬äº‹ä»¶ã€‚</p>
  </li>
</ul>

<h3 id="ä¸­é—´å±‚">ä¸­é—´å±‚</h3>
<p>å»ºç«‹ä¸­é—´å±‚çš„ç›®çš„æ˜¯ç»Ÿä¸€å¯¹æ‰€æœ‰Weex pageçš„eventsåšè½¬å‘ï¼Œä¸€æ¥æ˜¯æ–¹ä¾¿åšhookï¼ŒäºŒæ¥æ˜¯é˜²æ­¢pluginä¸pluginä¹‹é—´äº’ç›¸ç›´æ¥è°ƒç”¨äº§ç”Ÿè€¦åˆã€‚å¦‚æœæ²¡æœ‰ç»Ÿä¸€çš„ä¸­é—´å±‚å’Œæ´¾å‘å…³ç³»ï¼Œæƒ³è±¡ä¸€ä¸‹ç»´æŠ¤è¿‡Nä¸ªç‰ˆæœ¬ä¹‹åçš„æ‚ä¹±æ— ç« çš„è°ƒç”¨å…³ç³»â€¦</p>

<p>æ¢³ç†ä¸‹æˆ‘ä»¬æœŸå¾…çš„æµç¨‹å›¾ï¼š</p>

<p><img src="https://raw.githubusercontent.com/Mioke/resources/master/images/weex_native_transport.png" alt="image" /></p>

<h4 id="ç»‘å®šäº‹ä»¶">ç»‘å®šäº‹ä»¶</h4>
<p>æ¯ä¸ªWeex instanceéƒ½å¯ä»¥ç»‘å®šmoduleæ¥å¤„ç†äº‹ä»¶ï¼Œæ‰€ä»¥moduleçš„å®ä¾‹ä¹Ÿæ˜¯åˆ†æ•£å½¢å¼çš„ã€‚æˆ‘ä»¬ç”¨ç»Ÿä¸€çš„ç±»<code class="language-plaintext highlighter-rouge">XLPluginEvent</code>æ¥æ”¶é›†ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯è½¬åˆ°ç»Ÿä¸€çš„ä¸­é—´å±‚ç±»<code class="language-plaintext highlighter-rouge">XLWxPluginMediator</code>åšå¤„ç†ã€‚</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">WXSDKEngine</span> <span class="nf">registerModule</span><span class="p">:</span><span class="s">@"mediator"</span> <span class="nf">withClass</span><span class="p">:</span><span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@"XLPluginEvent"</span><span class="p">)];</span>

<span class="c1">// In XLPluginEvent class:</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendRequestData</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span>
                   <span class="nf">from</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">source</span>
               <span class="nf">toTarget</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">target</span>
               <span class="nf">callback</span><span class="p">:(</span><span class="n">WXModuleCallback</span><span class="p">)</span><span class="nv">callback</span> <span class="p">{</span>
    <span class="p">[[</span><span class="n">XLWxPluginMediator</span> <span class="nf">sharedInstance</span><span class="p">]</span> <span class="nf">sendRequestData</span><span class="p">:</span><span class="n">data</span>
                                                    <span class="nl">from:</span><span class="n">weexInstance</span>
                                                  <span class="nl">source:</span><span class="n">source</span>
                                                <span class="nl">toTarget:</span><span class="n">target</span>
                                                <span class="nl">callback:</span><span class="n">callback</span><span class="p">];</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¸­é—´å¤„ç†">ä¸­é—´å¤„ç†</h4>
<p><code class="language-plaintext highlighter-rouge">XLWxPluginMediator</code>åŒæ—¶å…·æœ‰æ¥æ”¶å’Œå‘é€åŠŸèƒ½ã€‚æ¥æ”¶eventä¹‹åä¼šæ ¹æ®eventé™„å¸¦çš„informationï¼Œåšæœ¬åœ°åˆ†å‘æˆ–æ’ä»¶åˆ†å‘ï¼Œä¸€èˆ¬ç”¨<code class="language-plaintext highlighter-rouge">target</code>æ ‡æ˜eventçš„ç›®æ ‡å¯¹è±¡ã€‚</p>
<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendRequestData</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span>
                   <span class="nf">from</span><span class="p">:(</span><span class="n">WXSDKInstance</span> <span class="o">*</span><span class="p">)</span><span class="nv">wx</span>
                 <span class="nf">source</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">source</span>
               <span class="nf">toTarget</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">target</span>
               <span class="nf">callback</span><span class="p">:(</span><span class="n">WXModuleCallback</span><span class="p">)</span><span class="nv">callback</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">target</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="s">@"native"</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// Notify all native listeners</span>
        
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 1 . find target</span>
<span class="c1">//        WXSDKInstance *target = [Finder findtarget];</span>
        <span class="c1">// 2 . fire a event &amp; wait to callback</span>
<span class="c1">//        [self sendEventTo:target params:data callback:callback];</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>nativeå‘pluginåšé€šä¿¡è¯·æ±‚<strong>æš‚æ—¶</strong>æ˜¯é€šè¿‡fireGlobalEventæ–¹æ³•å®ç°çš„ï¼ŒåŸå› æ˜¯ä½¿ç”¨fireEventä¼šä¸<strong>ç•Œé¢ç»‘å®š</strong>ï¼ŒæŸäº›åœºåˆæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸ç•Œé¢ç»‘å®šã€‚</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendEventTo</span><span class="p">:(</span><span class="n">WXSDKInstance</span> <span class="o">*</span><span class="p">)</span><span class="nv">wx</span> 
             <span class="nf">params</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">params</span>
           <span class="nf">callback</span><span class="p">:(</span><span class="n">WXModuleCallback</span><span class="p">)</span><span class="nv">callback</span> <span class="p">{</span>
           
    <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">paramsAddCallback</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableDictionary</span> <span class="nf">dictionaryWithDictionary</span><span class="p">:</span><span class="n">params</span><span class="p">];</span>
    <span class="p">[</span><span class="n">paramsAddCallback</span> <span class="nf">setObject</span><span class="p">:</span><span class="n">callback</span> <span class="nf">forKey</span><span class="p">:</span><span class="s">@"callback"</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">wx</span> <span class="nf">fireGlobalEvent</span><span class="p">:</span><span class="s">@"nativetransport"</span> <span class="nf">params</span><span class="p">:</span><span class="n">paramsAddCallback</span><span class="p">];</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ‹¥æœ‰å“åº”native eventçš„pluginå¿…é¡»åœ¨onCreateé‡Œå®ç°è¿™ä¸ªeventçš„ç›‘å¬ï¼š</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nx">created</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">globalEvent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@weex-module/globalEvent</span><span class="dl">'</span><span class="p">)</span>
            <span class="nx">globalEvent</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">nativetransport</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">},</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç”±æ­¤å°±å®ç°äº†pluginä¸nativeä¹‹é—´çš„åŒå‘ä¼ è¾“ã€‚</p>

<h4 id="plugins-ä¹‹é—´çš„ä¼ è¾“">Plugins ä¹‹é—´çš„ä¼ è¾“</h4>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="c1">// TODO: - </span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET
<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="How to make Swift Macro available using CocoaPods" /><meta name="author" content="Klein" /><meta property="og:locale" content="en" /><meta name="description" content="By the release of Swift 5.9, it provides the feature Swift Macro, which is really useful for the developer to reduce boilerplate code and helping to improve the readability of the code." /><meta property="og:description" content="By the release of Swift 5.9, it provides the feature Swift Macro, which is really useful for the developer to reduce boilerplate code and helping to improve the readability of the code." /><link rel="canonical" href="https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/" /><meta property="og:url" content="https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/" /><meta property="og:site_name" content="Klein Mioke" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-06T21:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to make Swift Macro available using CocoaPods" /><meta name="twitter:site" content="@Klein_Mioke" /><meta name="twitter:creator" content="@Klein" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Klein"},"dateModified":"2024-03-08T18:34:57+08:00","datePublished":"2024-03-06T21:00:00+08:00","description":"By the release of Swift 5.9, it provides the feature Swift Macro, which is really useful for the developer to reduce boilerplate code and helping to improve the readability of the code.","headline":"How to make Swift Macro available using CocoaPods","mainEntityOfPage":{"@type":"WebPage","@id":"https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/"},"url":"https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/"}</script><title>How to make Swift Macro available using CocoaPods | Klein Mioke</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Klein Mioke"><meta name="application-name" content="Klein Mioke"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://github.com/Mioke/mioke.github.io/raw/master/assets/img/avatar/avatar.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Klein Mioke</a></div><div class="site-subtitle font-italic">Klein's Memory Castle</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Mioke" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Klein_Mioke" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mioke0428','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } get isResolvedDarkMode() { if (this.isLightMode) { return false; } return this.isSysDarkPrefer; } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } updateCommentStyle() { var theme = "github-light"; if (this.isResolvedDarkMode) { theme = "photon-dark"; } let comment = document.querySelector("iframe.utterances-frame"); if (comment == null) { return; } comment.contentWindow.postMessage( { type: "set-theme", theme: theme }, "https://utteranc.es/" ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); this.updateCommentStyle(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How to make Swift Macro available using CocoaPods</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>How to make Swift Macro available using CocoaPods</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Klein </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Mar 6, 2024, 9:00 PM +0800" >Mar 6<i class="unloaded">2024-03-06T21:00:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Mar 8, 2024, 6:34 PM +0800" >Mar 8<i class="unloaded">2024-03-08T18:34:57+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1146 words">6 min read</span></div></div><div class="post-content"><p>By the release of Swift 5.9, it provides the feature <code class="language-plaintext highlighter-rouge">Swift Macro</code>, which is really useful for the developer to reduce boilerplate code and helping to improve the readability of the code.</p><p>However, as we know, currently most long running projects are using CocoaPods as their dependency manager, while the Swift Macro support officially relies on SwiftPM. This prevents macros from being directly used in the project code and development pods.</p><p>So this article is about to introduce how to make Swift Macro available using CocoaPods, for host project and other pods.</p><h2 id="key-point---using-an-executable-macro-plugin">Key Point - using an executable macro plugin</h2><p>Inspired by the information in <a href="https://forums.swift.org/t/how-to-import-macros-using-methods-other-than-swiftpm/66645/10/">this discussion</a> and <a href="https://www.polpiella.dev/binary-swift-macros">this post</a>, it shows that we can provide an executable binary to the Swift Compiler in Xcode settings: add <code class="language-plaintext highlighter-rouge">-load-plugin-executable &lt;path-to-plugin-executable&gt;#&lt;executable-module-name&gt;</code> to <code class="language-plaintext highlighter-rouge">OTHER_SWIFT_FLAGS</code>.</p><p>For example:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span text-data=" Ruby "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s1">'OTHER_SWIFT_FLAGS'</span> <span class="o">=&gt;</span> <span class="s1">'-load-plugin-executable Resources/Macros/MyMacroPlugin#MyMacroPlugin'</span><span class="p">,</span>
</pre></table></code></div></div><p>That means we can build a plugin executable and provide it through CocoaPods, update the settings in Pods project and host project before or after the <code class="language-plaintext highlighter-rouge">pod install</code> command.</p><p>Okay, let’s do it.</p><p>(All the example code can be found in <a href="https://github.com/Mioke/SwiftyArchitectureMacros">this repo</a>)</p><h2 id="create-a-macro-plugin-executable">Create a macro plugin executable</h2><p>We can easily create a demo macro project using Xcode 15 or command line <code class="language-plaintext highlighter-rouge">swift package init --type macro</code>. And then update the <code class="language-plaintext highlighter-rouge">Package.swift</code> like this:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span text-data=" Swift "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="c1">// swift-tools-version: 5.9</span>
<span class="c1">// The swift-tools-version declares the minimum version of Swift required to build this package.</span>

<span class="kd">import</span> <span class="kt">PackageDescription</span>
<span class="kd">import</span> <span class="kt">CompilerPluginSupport</span>

<span class="k">let</span> <span class="nv">package</span> <span class="o">=</span> <span class="kt">Package</span><span class="p">(</span>
    <span class="nv">name</span><span class="p">:</span> <span class="s">"SwiftyArchitectureMacros"</span><span class="p">,</span>
    <span class="nv">platforms</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="nf">macOS</span><span class="p">(</span><span class="o">.</span><span class="n">v10_15</span><span class="p">),</span> <span class="o">.</span><span class="nf">iOS</span><span class="p">(</span><span class="o">.</span><span class="n">v13</span><span class="p">),</span> <span class="o">.</span><span class="nf">tvOS</span><span class="p">(</span><span class="o">.</span><span class="n">v13</span><span class="p">),</span> <span class="o">.</span><span class="nf">watchOS</span><span class="p">(</span><span class="o">.</span><span class="n">v6</span><span class="p">),</span> <span class="o">.</span><span class="nf">macCatalyst</span><span class="p">(</span><span class="o">.</span><span class="n">v13</span><span class="p">)],</span>
    <span class="nv">products</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">// Product which is a executable plugin for other project's compiler to integrate.</span>
        <span class="o">.</span><span class="nf">executable</span><span class="p">(</span>
            <span class="nv">name</span><span class="p">:</span> <span class="s">"SwiftyArchitectureMacros"</span><span class="p">,</span>
            <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span><span class="s">"SwiftyArchitectureMacros"</span><span class="p">]),</span>
    <span class="p">],</span>
    <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">// Depend on the Swift 5.9 release of SwiftSyntax</span>
        <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/apple/swift-syntax.git"</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="s">"509.0.0"</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span>
         <span class="o">.</span><span class="nf">executableTarget</span><span class="p">(</span>
             <span class="nv">name</span><span class="p">:</span> <span class="s">"SwiftyArchitectureMacros"</span><span class="p">,</span>
             <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
                 <span class="o">.</span><span class="nf">product</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"SwiftSyntaxMacros"</span><span class="p">,</span> <span class="nv">package</span><span class="p">:</span> <span class="s">"swift-syntax"</span><span class="p">),</span>
                 <span class="o">.</span><span class="nf">product</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"SwiftCompilerPlugin"</span><span class="p">,</span> <span class="nv">package</span><span class="p">:</span> <span class="s">"swift-syntax"</span><span class="p">)</span>
             <span class="p">]</span>
         <span class="p">),</span>
        <span class="c1">// A test target used to develop the macro implementation.</span>
        <span class="o">.</span><span class="nf">testTarget</span><span class="p">(</span>
            <span class="nv">name</span><span class="p">:</span> <span class="s">"MacrosTests"</span><span class="p">,</span>
            <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
                <span class="s">"SwiftyArchitectureMacros"</span><span class="p">,</span>
                <span class="o">.</span><span class="nf">product</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"SwiftSyntaxMacrosTestSupport"</span><span class="p">,</span> <span class="nv">package</span><span class="p">:</span> <span class="s">"swift-syntax"</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></table></code></div></div><p>There are some important informations:</p><ol><li><p>The target <code class="language-plaintext highlighter-rouge">SwiftyArchitectureMacros</code> must be a executable target, normally it’s a <code class="language-plaintext highlighter-rouge">.macro</code> target. And the product of the executable should target on the executable <code class="language-plaintext highlighter-rouge">SwiftyArchitectureMacros</code>.</p><li><p>Second, by several tests, the executable target should contain original macro files, not macro definition files. So it means that the definition of the macro should be contained in the pod we build.</p></ol><p>By using this <code class="language-plaintext highlighter-rouge">swift build -c release</code> command, we can get a <code class="language-plaintext highlighter-rouge">SwiftyArchitectureMacros</code> executable file in <code class="language-plaintext highlighter-rouge">.build/release/</code>.</p><h2 id="create-a-pod-to-host-the-macro-plugin-executable">Create a pod to host the macro plugin executable</h2><h3 id="using-a-prepared-macro-executable">Using a prepared macro executable</h3><p>Next, we will create a podspec file to host the executable file and add some configurations.</p><p>We can create a <code class="language-plaintext highlighter-rouge">.podspec</code> now, and in my case it is <code class="language-plaintext highlighter-rouge">SwiftyArchitectureMacrosPackage.podspec</code>. The key content is below.</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span text-data=" Ruby "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">s</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s1">'Sources/MacrosDefine/*'</span>
<span class="n">s</span><span class="p">.</span><span class="nf">preserve_paths</span> <span class="o">=</span> <span class="s1">'Products/**/*'</span>

<span class="n">xcode_config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'OTHER_SWIFT_FLAGS'</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;-</span><span class="no">FLAGS</span><span class="p">.</span><span class="nf">squish</span><span class="sh">
  -Xfrontend -load-plugin-executable
  -Xfrontend $(PODS_ROOT)/SwiftyArchitectureMacrosPackage/Products/SwiftyArchitectureMacros#SwiftyArchitectureMacros
</span><span class="no">  FLAGS</span>
<span class="p">}</span>

<span class="n">s</span><span class="p">.</span><span class="nf">user_target_xcconfig</span> <span class="o">=</span> <span class="n">xcode_config</span> <span class="c1"># &lt;-- add to the `Host project`.</span>
<span class="n">s</span><span class="p">.</span><span class="nf">pod_target_xcconfig</span> <span class="o">=</span> <span class="n">xcode_config</span>
</pre></table></code></div></div><p>Key points:</p><ol><li><p>The <code class="language-plaintext highlighter-rouge">source_files</code> should contain the macro definition files, which are the files that contains the macro definitions like:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span text-data=" Swift "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">@freestanding</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">macro</span> <span class="n">stringify</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">T</span><span class="p">,</span> <span class="kt">String</span><span class="p">)</span> <span class="o">=</span> <span class="k">#externalMacro</span><span class="p">(</span><span class="nv">module</span><span class="p">:</span> <span class="s">"SwiftyArchitectureMacros"</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="s">"StringifyMacro"</span><span class="p">)</span>
</pre></table></code></div></div><li>The <code class="language-plaintext highlighter-rouge">preserve_paths</code> should contain the executable file, which we build before and move it to a folder, like <code class="language-plaintext highlighter-rouge">Products/</code>.<li>The <code class="language-plaintext highlighter-rouge">user_target_xcconfig</code> and <code class="language-plaintext highlighter-rouge">pod_target_xcconfig</code> should contain the same configurations, which integrate the executable to compiler plugin.<li>The <code class="language-plaintext highlighter-rouge">s.user_target_xcconfig</code> is used to modify settings of the host project, while the <code class="language-plaintext highlighter-rouge">s.pod_target_xcconfig</code> is used to modify settings of the current pod target.</ol><h3 id="using-a-script-to-build-a-executable">Using a script to build a executable</h3><p>Inspired by <a href="https://soumyamahunt.medium.com/support-swift-macros-with-cocoapods-3911f9317042">this post</a>, we can also use a script to build the executable.</p><p>We can create another <code class="language-plaintext highlighter-rouge">.podspec</code> file, which is <code class="language-plaintext highlighter-rouge">SwiftyArchitectureMacros.podspec</code> in my case, and the key content is below.</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span text-data=" Ruby "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">s</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s1">'Sources/MacrosDefine/*'</span>
<span class="n">s</span><span class="p">.</span><span class="nf">preserve_paths</span> <span class="o">=</span> <span class="s1">'Package.swift'</span><span class="p">,</span> <span class="s1">'Sources/**/*'</span><span class="p">,</span> <span class="s1">'Tests/**/*'</span>

<span class="n">product_folder</span> <span class="o">=</span> <span class="s2">"${PODS_BUILD_DIR}/Products/SwiftyArchitectureMacros"</span>

<span class="n">script</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">SCRIPT</span><span class="p">.</span><span class="nf">squish</span><span class="sh">
env -i PATH="$PATH" "$SHELL" -l -c
"swift build -c release --product SwiftyArchitectureMacros
--package-path </span><span class="se">\\</span><span class="sh">"$PODS_TARGET_SRCROOT</span><span class="se">\\</span><span class="sh">"
--scratch-path </span><span class="se">\\</span><span class="sh">"</span><span class="si">#{</span><span class="n">product_folder</span><span class="si">}</span><span class="se">\\</span><span class="sh">""
</span><span class="no">SCRIPT</span>

<span class="n">s</span><span class="p">.</span><span class="nf">script_phase</span> <span class="o">=</span> <span class="p">{</span>
 <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Build SwiftyArchitectureMacros macro plugin'</span><span class="p">,</span>
 <span class="ss">:script</span> <span class="o">=&gt;</span> <span class="n">script</span><span class="p">,</span>
 <span class="ss">:input_files</span> <span class="o">=&gt;</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="s2">"{Package.swift, Sources/**/*}"</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span>
   <span class="o">|</span><span class="n">path</span><span class="o">|</span> <span class="s2">"$(PODS_TARGET_SRCROOT)/</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span>
 <span class="p">},</span>
 <span class="ss">:output_files</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">product_folder</span><span class="si">}</span><span class="s2">/release/SwiftyArchitectureMacros"</span><span class="p">],</span>
 <span class="ss">:execution_position</span> <span class="o">=&gt;</span> <span class="ss">:before_compile</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Besides the key points introduced above, this section also needs attention to several other key points:</p><ol><li>The <code class="language-plaintext highlighter-rouge">preserve_paths</code> should contain the <code class="language-plaintext highlighter-rouge">Package.swift</code> and files that are used to build the executable.<li>And don’t forget to update the build config path to <code class="language-plaintext highlighter-rouge">#{product_folder}/release/SwiftyArchitectureMacros#SwiftyArchitectureMacros</code>.</ol><p>The benefit is that we don’t need to prepare the executable file, it will be built by the script when the main project starts building, and it won’t have any compatible issue. However you should know that the script will be executed every time when the project builds, and it may takes a long time when there’s no build cache. So I suggest as a SDK provider, you should provide both options.</p><h2 id="integrate-to-other-targets">Integrate to other targets</h2><h3 id="host-project">Host project</h3><p>If your main codes are in the host project, you can integrate the macro plugin to the host project by adding the following code to the <code class="language-plaintext highlighter-rouge">Podfile</code>.</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span text-data=" Ruby "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">pod</span> <span class="s1">'SwiftyArchitectureMacrosPackage'</span>
<span class="c1">#or</span>
<span class="n">pod</span> <span class="s1">'SwiftyArchitectureMacros'</span>
</pre></table></code></div></div><p>Because of the <code class="language-plaintext highlighter-rouge">OTHER_SWIFT_FLAG</code> setting are already inserted by the <code class="language-plaintext highlighter-rouge">podspec</code> file into the host project settings, you don’t need to do anything else.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span text-data=" Swift "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">SwiftyArchitectureMacrosPackage</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">a</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">let</span> <span class="nv">b</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">let</span> <span class="nv">desc</span> <span class="o">=</span> <span class="k">#stringify</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>It works fine~</p><h3 id="used-by-other-pods-or-development-pods">Used by other pods or development pods</h3><p>First, add the dependency in the other’s podspec:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span text-data=" Ruby "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">s</span><span class="p">.</span><span class="nf">dependency</span> <span class="s1">'SwiftyArchitectureMacrosPackage'</span>
</pre></table></code></div></div><p>And then it will be a little tricky, because we can’t directly insert the <code class="language-plaintext highlighter-rouge">OTHER_SWIFT_FLAG</code> into other pod target settings because:</p><ol><li>In another’s podspec, hard code the executable path is not a good idea, because the path may changes when you switching the macro pod between local and remote.<li>If a lot of pods are depending on the macro pod, when macro pod setting changes you must update all the pods’ podspec file which is a big trouble.</ol><p>So we need to do some tricks. We can use <code class="language-plaintext highlighter-rouge">pod install</code>’s <code class="language-plaintext highlighter-rouge">post_install</code> hook to do this. Add these code to your <code class="language-plaintext highlighter-rouge">Podfile</code>, it aims to add the <code class="language-plaintext highlighter-rouge">OTHER_SWIFT_FLAG</code> setting to the <code class="language-plaintext highlighter-rouge">Pods.xcodeproj</code>, and all the pod targets will inherit from it.</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span text-data=" Ruby "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">post_install</span> <span class="k">do</span> <span class="o">|</span><span class="n">installer_representation</span><span class="o">|</span>

  <span class="n">macro_product_folder</span> <span class="o">=</span> <span class="s2">"${PODS_BUILD_DIR}/Products/SwiftyArchitectureMacros"</span>

  <span class="n">installer_representation</span><span class="p">.</span><span class="nf">pods_project</span><span class="p">.</span><span class="nf">build_configurations</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">build_settings</span><span class="p">[</span><span class="s1">'OTHER_SWIFT_FLAGS'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"$(inherited) -load-plugin-executable </span><span class="si">#{</span><span class="n">macro_product_folder</span><span class="si">}</span><span class="s2">/release/SwiftyArchitectureMacros#SwiftyArchitectureMacros"</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></table></code></div></div><p>Now try <code class="language-plaintext highlighter-rouge">pod install</code> and see if all the pod targets are inheriting correctly from the <code class="language-plaintext highlighter-rouge">Pods.xcodeproj</code>. If so, you can use the macros in your codes now.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tech/'>Tech</a>, <a href='/categories/swift/'>Swift</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/tech/" class="post-tag no-text-decoration" >Tech</a> <a href="/tags/swift/" class="post-tag no-text-decoration" >Swift</a> <a href="/tags/rust/" class="post-tag no-text-decoration" >Rust</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How to make Swift Macro available using CocoaPods - Klein Mioke&url=https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How to make Swift Macro available using CocoaPods - Klein Mioke&u=https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=How to make Swift Macro available using CocoaPods - Klein Mioke&url=https://mioke.github.io/posts/How-to-make-macro-available-from-CocoaPods/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/How-to-make-macro-available-from-CocoaPods/">How to make Swift Macro available using CocoaPods</a><li><a href="/posts/Swift-Tips-(3)/">Swift Tips (3) - Protocol</a><li><a href="/posts/Talk-abould-the-politics/">When we talk about politics</a><li><a href="/posts/Why-we-struggled-using-navite-code-to-build-apps/">Why we struggled using native code to build apps</a><li><a href="/posts/Swift-Tips-(2)/">Swift Tips (2) - Standards</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/frp/">FRP</a> <a class="post-tag" href="/tags/reactiveswift/">ReactiveSwift</a> <a class="post-tag" href="/tags/rxswift/">RxSwift</a> <a class="post-tag" href="/tags/view-points/">View Points</a> <a class="post-tag" href="/tags/codable/">Codable</a> <a class="post-tag" href="/tags/functional/">Functional</a> <a class="post-tag" href="/tags/pop/">POP</a> <a class="post-tag" href="/tags/rust/">Rust</a> <a class="post-tag" href="/tags/tech/">Tech</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Swift-Tips-(2)/"><div class="card-body"> <span class="timeago small" >Jun 7, 2018<i class="unloaded">2018-06-07T15:35:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Swift Tips (2) - Standards</h3><div class="text-muted small"><p> 方法参数命名规范 由于Objective-C API的命名转换，到Swift API的更新，现在（Swift 4.0）我们更应该使用靠近Swift系统的命名方式： func convert(_ point: CGPoint, from view: UIView?) -&gt; CGPoint 不符合规范的：func convertPoint(_ point: CGPoint, ...</p></div></div></a></div><div class="card"> <a href="/posts/Swift-Tips-(3)/"><div class="card-body"> <span class="timeago small" >Jun 7, 2018<i class="unloaded">2018-06-07T15:55:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Swift Tips (3) - Protocol</h3><div class="text-muted small"><p> protocol 组合 其实 Any 是 protocol&lt;&gt; 的同名写法，可以用来表示任意类型。protocol&lt;&gt; 的标准语法形式是：protocol&lt;ProtocolA, ProtocalB&gt;。protocol 组合是可以使用 typealias 来命名的，这样可以提高我们的代码可读性： typealise ServerType = protoc...</p></div></div></a></div><div class="card"> <a href="/posts/Swift-Codable/"><div class="card-body"> <span class="timeago small" >Jun 13, 2018<i class="unloaded">2018-06-13T10:55:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Codable introduced in Swift 4.0</h3><div class="text-muted small"><p> Swift Codable Codable 其实是组合协议： typealiase Codable = Encodable &amp; Decodable Swift 基础库中的 Codable、JSONEncoder、PropertiesListEncoder 给我们提供了日常所用的基础功能。使用起来也很简单，以 JSONEncoder 为例。 struct Cat: Codab...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Talk-abould-the-politics/" class="btn btn-outline-primary" prompt="Older"><p>When we talk about politics</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div><div class="utterances-container"> <script src="https://utteranc.es/client.js" repo="Mioke/mioke.github.io.comments" issue-term="pathname" theme="photon-dark" crossorigin="anonymous" async> </script></div><script type="text/javascript"> $(function() { window.onmessage = evt => { if (evt.origin === 'https://utteranc.es') { toggle.updateCommentStyle(); window.onmessage = null; } } }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Mioke">Klein</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/frp/">FRP</a> <a class="post-tag" href="/tags/reactiveswift/">ReactiveSwift</a> <a class="post-tag" href="/tags/rxswift/">RxSwift</a> <a class="post-tag" href="/tags/view-points/">View Points</a> <a class="post-tag" href="/tags/codable/">Codable</a> <a class="post-tag" href="/tags/functional/">Functional</a> <a class="post-tag" href="/tags/pop/">POP</a> <a class="post-tag" href="/tags/rust/">Rust</a> <a class="post-tag" href="/tags/tech/">Tech</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
